name: Auto Link Issue from Branch Name

on:
  pull_request:
    types: [opened]

jobs:
  link-issue:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
    steps:
      - name: Link Issue
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const match = branchName.match(/#(\d+)$/);
            
            if (!match) {
              console.log("ブランチ名にIssue番号が見つかりませんでした。");
              return;
            }

            const issueNumber = parseInt(match[1]);
            let body = context.payload.pull_request.body || "";
            let replacementText = "";

            if (branchName.startsWith('subfeature/') || branchName.startsWith('debug/')) {
              // --- Sub Issue / Debug Issue の場合 ---
              let parentIssueNumber = null;
              try {
                const subIssue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                // 本文から親Issue番号を探す（正規表現はプロジェクトのテンプレート形式に合わせる）
                const parentMatch = subIssue.data.body.match(/親となる Main Issue の番号\s+#(\d+)/);
                parentIssueNumber = parentMatch ? parentMatch[1] : null;
              } catch (e) {
                console.error("Issue情報の取得に失敗:", e.message);
              }

              replacementText = `- **Main Issue**: ${parentIssueNumber ? '#' + parentIssueNumber : '未指定'}\n- **Sub / Debug Issue**: Resolves #${issueNumber}`;

            } else if (branchName.startsWith('feature/')) {
              // --- Main Issue の場合 ---
              replacementText = `- **Main Issue**: Resolves #${issueNumber}`;
            } else {
              // その他（予備）
              replacementText = `Resolves #${issueNumber}`;
            }

            // プレースホルダーを置換
            const placeholder = "<!-- AUTOMATED_ISSUE_BLOCK -->";
            if (body.includes(placeholder)) {
              body = body.replace(placeholder, replacementText);
            } else {
              // プレースホルダーがない場合は先頭に追記
              body = `${replacementText}\n\n${body}`;
            }

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: body
            });
