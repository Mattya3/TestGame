name: Auto Close Linked Issues on Merge

on:
  pull_request:
    types: [closed]

jobs:
  close-linked-issues:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Close Linked Issues
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body;
            if (!body) return;

            // GitHubの自動クローズキーワードに対応する正規表現
            // Resolves #1, Closes #2, Fixes #3 などを抽出
            const regex = /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)\b/gi;
            let match;
            const issueNumbers = new Set();

            while ((match = regex.exec(body)) !== null) {
              issueNumbers.add(parseInt(match[1]));
            }

            if (issueNumbers.size === 0) {
              console.log("No linked issues found in PR body.");
              return;
            }

            for (const issueNumber of issueNumbers) {
              try {
                console.log(`Closing issue #${issueNumber}`);
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed',
                  state_reason: 'completed'
                });

                // コメントを残すと親切
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `PR #${context.payload.pull_request.number} がマージされたため，このIssueを自動的にクローズしました．`
                });
              } catch (error) {
                console.error(`Failed to close issue #${issueNumber}: ${error.message}`);
              }
            }
